Menu="NetworkServices:999"
Title="FTP Server"
Icon="icon-ftp"
Tag="globe"
---
<?PHP
/* Copyright 2005-2020, Lime Technology
 * Copyright 2012-2020 Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>
<?
// Don't need this file any more - IMTheNachoMan on 2021-09-16
// $ftp_userlist_file = "/boot/config/vsftpd.user_list";

// Where we'll save what each user's chroot jail is - IMTheNachoMan on 2021-09-16
$user_config_dir = "/boot/config/vsftpd.user_config_dir";

$ftp_userlist = "";
// We can't just get the conents of a file. We have to iterate through the files in a directory - IMTheNachoMan on 2021-09-16
// if (file_exists($ftp_userlist_file)) {
//   $ftp_userlist = str_replace("\n", " ", trim(file_get_contents($ftp_userlist_file)));
//   if ($ftp_userlist === false) $ftp_userlist = "";
// }

// new code start - IMTheNachoMan on 2021-09-16

$ftp_userlist_items = array();

// make sure we have a folder
if(file_exists($user_config_dir) && is_dir($user_config_dir))
{
    // go through all of the files, read their content, and piece together the necessary syntax
    foreach(array_diff(scandir($user_config_dir), array(".", "..")) as $filename)
    {
        $user_config = trim(file_get_contents($user_config_dir . "/" . $filename));
        $user_config_parts = explode("=", $user_config);
        array_push($ftp_userlist_items, $filename . "=" . $user_config_parts[1]);
    }
}

$ftp_userlist = implode("; ", $ftp_userlist_items);

// end new code - IMTheNachoMan on 2021-09-16
$ftp_server = exec("lsof -i:21 -Pln|awk '/\(LISTEN\)/{print $2;exit}'") ? 1 : 0;
?>
<script>
$(function() {
  showStatus('21');
});
</script>

<form markdown="1" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#command" value="/webGui/scripts/ftpusers">

_(FTP server)_:
: <select name="#arg[1]">
  <?=mk_option($ftp_server, "0", _("Disabled"))?>
  <?=mk_option($ftp_server, "1", _("Enabled"))?>
  </select>

:ftp_server_help:

_(FTP user(s))_:
: <input type="text" name="#arg[2]" size="40" maxlength="80" value="<?=htmlspecialchars($ftp_userlist)?>">

:ftp_users_help:

&nbsp;
: <input type="submit" value="_(Apply)_" disabled><input type="button" value="_(Done)_" onclick="done()">

</form>

:ftp_overview_help:
